---
title: "Código de Análisis de Datos"
author: "Cristóbal Ortiz"
output: html_document
---

```{r setup-markdown,include=FALSE}
knitr::opts_chunk$set(warning = FALSE,message = FALSE, cache = TRUE)
knitr::opts_knit$set(root.dir = "../")
options(scipen=999)
options(knitr.kable.NA = '')
```

```{r load-library, include=FALSE}
library(tidyverse)
library(lme4)
library(texreg)
library(vtable)
library(psych)
library(sjPlot)
library(cowplot)

library(lavaan)
library(lavaanPlot)
library(semPlot)
library(foreign)
library(sjmisc)
library(knitr)
library(semTable)
library(semptools)
#devtools::install_github("dr-JT/semoutput")
library(semoutput)


```

```{r load-dataset-proc, include=FALSE}
getwd()
rm(list=ls())
load("../1_input/data/procesada/elsoc_ams.RData")
#load("../3_output/modelos/sem_models.RData")
#View(elsoc_sub)

elsoc_sub <- elsoc_ams %>% 
  dplyr::select(idencuesta, cod_zona, apbi, soci, segui, repbi, sacci, essui, educi, educ,
                hete, segr, hi_theil, prom_ismt) %>% 
  drop_na()
```


```{r correlation}


correl <-  elsoc_sub %>% dplyr::select(-idencuesta, -cod_zona, everything()) %>% cor()

pairs.panels(elsoc_sub,
             smooth = TRUE,      # If TRUE, draws loess smooths
             scale = FALSE,      # If TRUE, scales the correlation text font
             density = TRUE,     # If TRUE, adds density plots and histograms
             ellipses = F,       # If TRUE, draws ellipses
             method = "pearson", # Correlation method (also "spearman" or "kendall")
             pch = 21,           # pch symbol
             lm = TRUE,          # If TRUE, plots linear fit rather than the LOESS (smoothed) fit
             cor = TRUE,         # If TRUE, reports correlations
             jiggle = FALSE,     # If TRUE, data points are jittered
             factor = 2,         # Jittering factor
             hist.col = 4,       # Histograms color
             stars = TRUE,       # If TRUE, adds significance level with stars
             ci = TRUE)          # If TRUE, adds confidence intervals
```

# Modelos de ecuaciones estructurales

## Modelo estructural

```{r sem-model}
sem_mod <- '
# Modelo estructural
apbi ~ b1*segui + b2*repbi + b3*sacci + c1*hi_theil
segui ~ a1*hi_theil
repbi ~ a2*hi_theil
sacci ~ a3*hi_theil

#Covarianzas
segui ~~ repbi
repbi ~~ sacci
segui ~~ sacci

# Efecto indirecto
ind_segr_segui_apbi := a1*b1
ind_segr_repbi_apbi := a2*b2
ind_segr_sacci_apbi := a3*b3
 
# Efecto total
tot_segr_segui_apbi := c1 + (a1*b1)
tot_segr_repbi_apbi := c1 + (a2*b2)
tot_segr_sacci_apbi := c1 + (a3*b3)
'

fit_sem <- sem(sem_mod, data=elsoc_sub, se = "bootstrap", bootstrap = 5000)
summary(fit_sem, fit.measures=TRUE, standardized=TRUE)
```

```{r sem-table}
sem_table <- sem_paths(fit_sem, standardized = TRUE, ci = "standardized", ci_level = 0.95, print = TRUE)

sem_tables(fit_sem, standardized = TRUE, ci = "standardized")
```

```{r plot-sem1}
labels1 <- list(apbi = "Apego al\nbarrio", 
                hi_theil = "Segregación\nresidencial", 
                segui = "  Seguridad   \nbarrial", 
                repbi = " Reputación \nbarrial", 
                sacci = "Satisfacción\nbarrial")

plot_model <- lavaanExtra::nice_lavaanPlot(model = fit_sem, stand = TRUE, labels = labels1, coefs = F, sig = 0.05, node_options = list(shape = "box", fontname = "Serif"))
plot_model
save_png(plot_model, "../3_output/graficos/sem_model.png")

plot_sem_ams <- lavaanExtra::nice_lavaanPlot(model = fit_sem, stand = TRUE, labels = labels1, coefs = TRUE, sig = 0.05, node_options = list(shape = "box", fontname = "Serif"))
plot_sem_ams
save_png(plot_sem_ams, "../3_output/graficos/sem_ams.png")

```

```{r plot-sem2}
plot_sem <- semPaths(fit_sem, whatLabels = "std",  layout = "tree2", rotation = 1, style = "lisrel", residuals = F, curve = 1, curvature = 3, 
                     nCharNodes = 10, edge.label.cex = 1.15, sizeMan = 12, sizeMan2 = 4, optimizeLatRes = T, edge.color = "#000000")

plot_sem_p <- mark_sig(plot_sem, fit_sem)
plot(p_pa2)

```

## Mediación Multinivel: Upper-level mediation (2-1-1)

*Pendiente*: incluir variables de control sólo al nivel 1

```{r ml-sem-apbi, warning=FALSE}
ml_sem_apbi <- '
level: 1
      # Modelo estructural nivel 1
      apbi ~ b1*segui + b2*repbi + b3*sacci

      # Covarianzas
      segui ~~ repbi
      repbi ~~ sacci
      segui ~~ sacci
      
level: 2
      # Modelo estructural nivel 2
      apbi ~ b1*segui + b2*repbi + b3*sacci + c1*prom_ismt
      segui ~ a1*prom_ismt
      repbi ~ a2*prom_ismt
      sacci ~ a3*prom_ismt

      # Efecto indirecto 
      ind_segr_segui_apbi := a1*b1
      ind_segr_repbi_apbi := a2*b2
      ind_segr_sacci_apbi := a3*b3

      # Efecto total 
      tot_segr_segui_apbi := c1 + (a1*b1)
      tot_segr_repbi_apbi := c1 + (a2*b2)
      tot_segr_sacci_apbi := c1 + (a3*b3)
'

fit_ml_sem_apbi <- sem(ml_sem_apbi, data = elsoc_sub, cluster = "cod_zona")
#fit_ml_sem <- sem(ml_sem_apbi, data = elsoc_sub, cluster = "cod_zona", verbose = TRUE, optim.method = "em", em.iter.max = 20000,  em.fx.tol = 1e-08, em.dx.tol = 1e-04)

summary(fit_ml_sem_apbi, fit.measures = T)
#lavInspect(fit_ml_sem_apbi, "icc")
sem_paths(fit_ml_sem_apbi, standardized = TRUE, ci = "standardized", ci_level = 0.95, print = TRUE)
```

```{r ml-sem-soci, warning=FALSE}
ml_sem_soci <- '
level: 1
      # Modelo estructural nivel 1
      soci ~ b1*segui + b2*repbi + b3*sacci

      # Covarianzas
      segui ~~ repbi
      repbi ~~ sacci
      segui ~~ sacci
      
level: 2
      # Modelo estructural nivel 2
      soci ~ b1*segui + b2*repbi + b3*sacci + c1*prom_ismt
      segui ~ a1*prom_ismt
      repbi ~ a2*prom_ismt
      sacci ~ a3*prom_ismt

      # Efecto indirecto 
      ind_segr_segui_soci := a1*b1
      ind_segr_repbi_soci := a2*b2
      ind_segr_sacci_soci := a3*b3

      # Efecto total 
      tot_segr_segui_soci := c1 + (a1*b1)
      tot_segr_repbi_soci := c1 + (a2*b2)
      tot_segr_sacci_soci := c1 + (a3*b3)
'

fit_ml_sem_soci <- sem(ml_sem_soci, data = elsoc_sub, cluster = "cod_zona")
summary(fit_ml_sem_soci, fit.measures = T)
lavInspect(fit_ml_sem_soci, "icc")
sem_paths(fit_ml_sem_soci, standardized = TRUE, ci = "standardized", ci_level = 0.95, print = TRUE)

```


## Modelo estructural por clases sociales

```{r dist-theil-educ}
q <- quantile(elsoc_sub$hi_theil, probs = c(0.25, 0.5, 0.75))
quantile(elsoc_sub$hi_theil)

ggplot(elsoc_sub, aes(x = hi_theil)) + 
  geom_histogram(aes(y=..density..),
                   binwidth=.05,
                   colour="gray", fill="gray") +
  geom_density(alpha=.2, fill="purple") + 
  geom_vline(xintercept = q[1], colour = "red") +
  geom_text(aes(x=q[1], label="\n25%", y=1), colour="red", angle=90) +
  geom_vline(xintercept = q[2], colour = "green") +
  geom_text(aes(x=q[2], label="\n50%", y=1), colour="green", angle=90) +
  geom_vline(xintercept = q[3], colour = "blue") +
  geom_text(aes(x=q[3], label="\n75%", y=1), colour="blue", angle=90) +
  scale_y_continuous(breaks = c(0, 1, 2, 3), 
                     labels = c("0", "25", "50", "75")) +
  xlab("Segregación residencial (Indice de Theil)") +
  ylab("N de residentes")


q2 <- quantile(elsoc_sub$educi, probs = c(0.25, 0.5, 0.75))
quantile(elsoc_sub$educi)
#  0%  25%  50%  75% 100% 
#  1    4    5    7   10 

ggplot(elsoc_sub, aes(x = educi)) + 
  geom_histogram(aes(y=..density..),
                   binwidth=1,
                   colour="gray", fill="gray") +
  geom_density(alpha=.2, fill="yellow") + 
  geom_vline(xintercept = q2[1], colour = "red") +
  geom_text(aes(x=q2[1], label="\n25%", y=0.05), colour="red", angle=90) +
  geom_vline(xintercept = q2[2], colour = "green") +
  geom_text(aes(x=q2[2], label="\n50%", y=0.05), colour="green", angle=90) +
  geom_vline(xintercept = q2[3], colour = "blue") +
  geom_text(aes(x=q2[3], label="\n75%", y=0.05), colour="blue", angle=90) +
  scale_y_continuous(breaks = c(0.0, 0.1, 0.2),labels = c("0", "50", "100")) +
  xlab("Nivel educacional") +
  ylab("N de residentes")

ggsave(filename = "../3_output/graficos/dist_educ.jpg", width = 25, height = 15, units = "cm")
```

```{r subset-class}
quantile(elsoc_sub$educi)
#  0%  25%  50%  75% 100% 
#  1    4    5    7   10 

#subset para 0%-25%
elsoc_low <- elsoc_sub %>% 
  filter(educi <= quantile(elsoc_sub$educi)[2]) 

#subset para 25%-50%
elsoc_middle_low <- elsoc_sub %>% 
  filter((educi > quantile (elsoc_sub$educi)[2] &
            educi <= quantile(elsoc_sub$educi)[3]))

#subset para 50%-75%
elsoc_middle_high <- elsoc_sub %>% 
  filter((educi > quantile (elsoc_sub$educi)[3] &
            educi <= quantile(elsoc_sub$educi)[4]))

#subset para 75%-100%
elsoc_high <- elsoc_sub %>% 
  filter(educi > quantile (elsoc_sub$educi)[4])
```

```{r sem-low}
fit_sem_low <- sem(sem_mod, data=elsoc_low, se = "bootstrap", bootstrap = 5000)
summary(fit_sem_low, fit.measures=TRUE, standardized=TRUE)

plot_sem_low <- lavaanExtra::nice_lavaanPlot(model = fit_sem_low, stand = TRUE, labels = labels1, coefs = TRUE, sig = 0.05, node_options = list(shape = "box", fontname = "Serif"))
save_png(plot_sem_ams, "../3_output/graficos/sem_low.png")
```

```{r sem-middle-low}
fit_sem_middle_low <- sem(sem_mod, data=elsoc_middle_low, se = "bootstrap", bootstrap = 5000)
summary(fit_sem_middle_low, fit.measures=TRUE, standardized=TRUE)

plot_sem_middle_low <- lavaanExtra::nice_lavaanPlot(model = fit_sem_middle_low, stand = TRUE, labels = labels1, coefs = TRUE, sig = 0.05, node_options = list(shape = "box", fontname = "Serif"))
save_png(plot_sem_middle_low, "../3_output/graficos/sem_middle_low.png")

```

```{r sem-middle-high}
fit_sem_middle_high <- sem(sem_mod, data=elsoc_middle_high, se = "bootstrap", bootstrap = 5000)
summary(fit_sem_middle_high, fit.measures=TRUE, standardized=TRUE)

plot_sem_middle_high <- lavaanExtra::nice_lavaanPlot(model = fit_sem_middle_high, stand = TRUE, labels = labels1, coefs = TRUE, sig = 0.05, node_options = list(shape = "box", fontname = "Serif"))
save_png(plot_sem_middle_high, "../3_output/graficos/sem_middle_high.png")
```

```{r sem-high}
fit_sem_high <- sem(sem_mod, data=elsoc_high, se = "bootstrap", bootstrap = 5000)
summary(fit_sem_high, fit.measures=TRUE, standardized=TRUE)

plot_sem_high <- lavaanExtra::nice_lavaanPlot(model = fit_sem_high, stand = TRUE, labels = labels1, coefs = TRUE, sig = 0.05, node_options = list(shape = "box", fontname = "Serif"))
plot_sem_high
save_png(plot_sem_high, "../3_output/graficos/sem_high.png")
```

```{r save-models}
save(fit_sem, fit_sem_low, fit_sem_middle_low, fit_sem_middle_high, fit_sem_high, fit_ml_sem, file = "../3_output/modelos/sem_models.RData")
```


