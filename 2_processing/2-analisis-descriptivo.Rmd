---
title: "Código de Análisis de Datos"
author: "Cristóbal Ortiz"
date: "08-10-2021"
output: html_document
---

```{r load-library, message=FALSE, warning=FALSE}
library(tidyverse)
library(sjPlot)
library(gstat)
library(raster)
library(rgdal)
library(rworldxtra)
library(sf)
library(sp)
library(rgeoda)
library(chilemapas)
library(mapview)
library(viridis)
library(elsoc)
library(sjlabelled)
library(ggpubr)
```

```{r load-dataset}
remove(list = ls())
load("../1_input/data/procesada/elsoc_ams.RData")
load("../1_input/data/procesada/elsoc_ams_all.RData")

load("../1_input/data/procesada/elsoc_ams_geo.RData")
load("../1_input/data/procesada/elsoc_ams_all_geo.RData")

#load(url("https://dataverse.harvard.edu/api/access/datafile/7245118"))
#elsoc_long <- elsoc_long_2016_2022.2
```

```{r summarise-dataset, message=TRUE, warning=FALSE}
elsoc_mean_zonas <- elsoc_ams %>% 
  group_by(cod_zona) %>% 
  dplyr::select(idencuesta, cod_zona, 
                apbi, soci, 
                segui, sacci, repbi, 
                edadi, educi, essui, time,  
                theil_pola, ismt_rank, theil_mixt, theil_segr, jane_indx) %>% 
  summarise_all(mean, na.rm = T)

elsoc_mean_zonas <- elsoc_mean_zonas %>% 
  mutate(gse_zona = factor(with(elsoc_mean_zonas, case_when(ismt_rank > 0.7325960 ~ 1,
                                                            ismt_rank > 0.5144 ~ 2,
                                                            ismt_rank <= 0.5144 ~ 3)),
                           labels = c('Alto', 'Medio', 'Bajo'),
                           levels = c(1,2,3)),
         theil_segr_f = factor(with(elsoc_mean_zonas, case_when(theil_segr > 0.7272 ~ 1,
                                                                theil_segr > 0.6178 ~ 2,
                                                                theil_segr <= 0.6178 ~ 3)),
                           labels = c('Segregación baja', 'Segregación media', 'Segregación alta'),
                           levels = c(3,2,1)),
         jane_indx_f = factor(with(elsoc_mean_zonas, case_when(jane_indx > 0.4780 ~ 1,
                                                               jane_indx > 0.1148 ~ 2,
                                                               jane_indx <= 0.1148 ~ 3)),
                           labels = c('Vitalidad baja', 'Vitalidad media', 'Vitalidad alta'),
                           levels = c(3,2,1)))
```
# Descriptivo general

```{r desc-table}
elsoc_ams2 <- elsoc_ams %>% 
  dplyr::select(-geometry)

summarytools::dfSummary(elsoc_ams2, style = "grid")
```


# Análisis univariado

```{r cob-estrato}
bar_apbi <- elsoc_long %>% 
  filter(tipo_atricion == 1 & ola %in% c(1,6), !is_nsnr(t02_01, t02_02, t02_03, t02_04)) %>% 
  mutate(spb = (t02_01 + t02_02 + t02_03 + t02_04)/4,
         spb_rec = factor(cut(spb, breaks = c(0,2.75,3.75,5)),
                                  labels = c("Niveles bajos","Niveles intermedios","Niveles altos")),
         estrato = factor(estrato, levels = c(1,2,3,4,5,6),
                          labels = c('Gran\nSantiago', 'Gran\nValparaíso', 'Gran\nConcepción',
                                     'Ciudades\ngrandes', 'Ciudades\nmedianas', 'Ciudades\npequeñas'))) %>% 
  prop(x = spb_rec, by = c(ola, estrato), na.rm = TRUE) %>% 
  as_label(ola) %>% 
  filter(spb_rec == "Niveles altos") %>% 
  ggplot(aes(y = prop, x = estrato, fill = ola, 
             label = as.character(scales::percent(prop, accuracy = .1)))) + 
  geom_col(position = 'dodge') +
  geom_errorbar(aes(ymin = prop - prop_se, ymax = prop + prop_se), 
                position = position_dodge(0.9), width = .2) +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 1)) +
  scale_fill_viridis_d(begin = .22, end = .88, direction = -1) +
  theme(plot.caption = element_text(hjust = 0),
        legend.position = 'top',
        legend.title = element_blank(),
        axis.text.x = element_text(size = 12)) +
  geom_text(position = position_dodge(0.9), vjust = -4, size = 3) +
  labs(x = NULL, y = NULL,
       title = 'Nivel de pertenencia al barrio según ola y tipo de ciudad',
       subtitle = 'Porcentaje con niveles altos (>3.75)')

bar_soci <- elsoc_long %>% 
  filter(tipo_atricion == 1 & ola %in% c(1,6), !is_nsnr(t02_01, t02_02, t02_03, t02_04)) %>% 
  mutate(soci = (t03_01 + t03_02 + t03_03 + t03_04)/4,
         soci_rec = factor(cut(soci, breaks = c(0,2.75,3.75,5)),
                                  labels = c("Niveles bajos","Niveles intermedios","Niveles altos")),
         estrato = factor(estrato, levels = c(1,2,3,4,5,6),
                          labels = c('Gran\nSantiago', 'Gran\nValparaíso', 'Gran\nConcepción',
                                     'Ciudades\ngrandes', 'Ciudades\nmedianas', 'Ciudades\npequeñas'))) %>% 
  prop(x = soci_rec, by = c(ola, estrato), na.rm = TRUE) %>% 
  as_label(ola) %>% 
  filter(soci_rec == "Niveles altos") %>% 
  ggplot(aes(y = prop, x = estrato, fill = ola, 
             label = as.character(scales::percent(prop, accuracy = .1)))) + 
  geom_col(position = 'dodge2') +
  geom_errorbar(aes(ymin = prop - prop_se, ymax = prop + prop_se), 
                position = position_dodge(0.9), width = .2) +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 1)) +
  scale_fill_viridis_d(begin = .22, end = .88, direction = -1) +
  theme(plot.caption = element_text(hjust = 0),
        legend.position = 'top',
        legend.title = element_blank(),
        axis.text.x = element_text(size = 12)) +
  geom_text(position = position_dodge(0.9), vjust = -4, size = 3) +
  labs(x = NULL, y = NULL,
       title = 'Nivel de sociabilidad barrial según ola y tipo de ciudad',
       subtitle = 'Porcentaje con niveles altos (>3.75)') 

bar_cob <- gridExtra::grid.arrange(bar_apbi, bar_soci,  ncol = 2)
ggsave(bar_cob,filename = "../3_output/graficos/1_bar_cob.png", width = 12, height = 6 , dpi = 300)

```

```{r boxplot}
boxplot_apbi_segr <- elsoc_mean_zonas %>% 
  ggplot(aes(y = apbi, x = theil_segr_f, fill = gse_zona)) +
  geom_boxplot() +
  labs(x = "", 
       y = "Pertenencia",
       fill = "GSE Zona") +
  theme(legend.position = "top",
        legend.title = element_text(size = 10),
        legend.text = element_text(size = 10),
        axis.title = element_text(size = 10, face = "bold")) +
  scale_fill_viridis(discrete = TRUE, option = "D")

boxplot_soci_segr <- elsoc_mean_zonas %>% 
  ggplot(aes(y = soci, x = theil_segr_f, fill = gse_zona)) +
  geom_boxplot() +
  labs(x = "", 
       y = "Sociabilidad",
       fill = "GSE Zona") +
  theme(legend.position = "top",
        legend.title = element_text(size = 10),
        legend.text = element_text(size = 10),
        axis.title = element_text(size = 10, face = "bold")) +
  scale_fill_viridis(discrete = TRUE, option = "D")

boxplot_apbi_jane <- elsoc_mean_zonas %>% 
  ggplot(aes(y = apbi, x = jane_indx_f, fill = gse_zona)) +
  geom_boxplot() +
  labs(x = "", 
       y = "Pertenencia",
       fill = "GSE Zona") +
  theme(legend.position = "top",
        legend.title = element_text(size = 10),
        legend.text = element_text(size = 10),
        axis.title = element_text(size = 10, face = "bold")) +
  scale_fill_viridis(discrete = TRUE, option = "D")


boxplot_soci_jane <- elsoc_mean_zonas %>% 
  ggplot(aes(y = soci, x = jane_indx_f, fill = gse_zona)) +
  geom_boxplot() +
  labs(x = "", 
       y = "Sociabilidad",
       fill = "GSE Zona") +
  theme(legend.position = "top",
        legend.title = element_text(size = 10),
        legend.text = element_text(size = 10),
        axis.title = element_text(size = 10, face = "bold")) +
  scale_fill_viridis(discrete = TRUE, option = "D")

boxplot_dse_cob <- ggarrange(boxplot_apbi_segr, boxplot_soci_segr, boxplot_apbi_jane, boxplot_soci_jane,  ncol = 2, nrow = 2, common.legend = TRUE, legend="top")
ggsave(boxplot_dse_cob,filename = "../3_output/graficos/2_boxplot_dse_cob.png", width = 8, height = 8, dpi = 300)
```


# Análisis bivariado

```{r correlation}
psych::pairs.panels(elsoc_mean_zonas,
             smooth = TRUE,      # If TRUE, draws loess smooths
             scale = FALSE,      # If TRUE, scales the correlation text font
             density = TRUE,     # If TRUE, adds density plots and histograms
             ellipses = F,       # If TRUE, draws ellipses
             method = "pearson", # Correlation method (also "spearman" or "kendall")
             pch = 21,           # pch symbol
             lm = TRUE,          # If TRUE, plots linear fit rather than the LOESS (smoothed) fit
             cor = TRUE,         # If TRUE, reports correlations
             jiggle = FALSE,     # If TRUE, data points are jittered
             factor = 2,         # Jittering factor
             hist.col = 4,       # Histograms color
             stars = TRUE,       # If TRUE, adds significance level with stars
             ci = TRUE)          # If TRUE, adds confidence intervals
```

## H1: segregación->cohesión & segregacion->ms~cohesion

```{r scat-segr, message=FALSE, warning=FALSE}
scat_apbi_segr <- elsoc_mean_zonas %>% 
  ggplot(aes(x = theil_segr, y = apbi, color = gse_zona)) +
  geom_point(size = 0.8) +
  #geom_smooth(method = "lm", se = F, size = 0.8) +
  geom_smooth(se = F, size = 0.8) +
  geom_smooth(aes(x = theil_segr, y = apbi), 
              method = "lm", se = F, inherit.aes = F, colour = "black", size = 1, linetype = "twodash") +
  labs(x = "Segregación", 
       y = "Pertenencia",
       color = "GSE Zona") +
  theme(legend.position = "top",
        legend.title = element_text(size = 10),
        legend.text = element_text(size = 10),
        axis.title = element_text(size = 10, face = "bold")) +
  scale_color_viridis(discrete = TRUE, option = "D")

scat_soci_segr <- elsoc_mean_zonas %>% 
  ggplot(aes(x = theil_segr, y = soci, color = gse_zona)) +
  geom_point(size = 0.8) +
  #geom_smooth(method = "lm", se = F, size = 0.8) +
  geom_smooth(se = F, size = 0.8) +
  geom_smooth(aes(x = theil_segr, y = soci), 
              method="lm", se = F, inherit.aes = F, colour = "black", size = 1, linetype = "twodash") +
  labs(x = "Segregación", 
       y = "Sociabilidad",
       color = "GSE Zona") +
  theme(legend.position = "top",
        legend.title = element_text(size = 10),
        legend.text = element_text(size = 10),
        axis.title = element_text(size = 10, face = "bold")) +
  scale_color_viridis(discrete = TRUE, option = "D")

#scatter_segr_cob <- ggarrange(scat_apbi_segr, scat_soci_segr, ncol = 2, common.legend = TRUE, legend="top")
#ggsave(scatter_segr_cob,filename = "../3_output/graficos/scatter_segr_cob.png", width = 10, height = 4)
#scatter_segr_cob
```
### H1.1 & H1.2
```{r scat-segr-ms}
#segregación~reputación

##segregación~reputación~apbi
scat_apbi_segr_repbi <- elsoc_mean_zonas %>% 
  drop_na() %>% 
  ggplot(aes(x = repbi, y = apbi, color = gse_zona)) +
  geom_point(size = 0.8) +
  geom_smooth(method = "lm", se = F, size = 0.8) +
  geom_smooth(aes(x = repbi, y = apbi), 
              method = "lm", se = F, inherit.aes = F, colour = "black", size = 1, linetype = "twodash") +
  labs(x = "Reputación", 
       y = "Pertenencia",
       color = "GSE Zona") +
  theme(legend.position = "top",
        legend.title = element_text(size = 8),
        legend.text = element_text(size = 8),
        axis.title = element_text(size = 10, face = "bold")) +
  scale_color_viridis(discrete = TRUE, option = "D") +
  facet_wrap(.~theil_segr_f)

##segregación~reputación~soci
scat_soci_segr_repbi <- elsoc_mean_zonas %>% 
  drop_na() %>% 
  ggplot(aes(x = repbi, y = soci, color = gse_zona)) +
  geom_point(size = 0.8) +
  geom_smooth(method = "lm", se = F, size = 0.8) +
  geom_smooth(aes(x = repbi, y = soci), 
              method = "lm", se = F, inherit.aes = F, colour = "black", size = 1, linetype = "twodash") +
  labs(x = "Reputación", 
       y = "Sociabilidad",
       color = "GSE Zona") +
  theme(legend.position = "top",
        legend.title = element_text(size = 8),
        legend.text = element_text(size = 8),
        axis.title = element_text(size = 10, face = "bold")) +
  scale_color_viridis(discrete = TRUE, option = "D") +
  facet_wrap(.~theil_segr_f)

#segregación~seguridad

##segregación~seguridad~apbi
scat_apbi_segr_segui <- elsoc_mean_zonas %>% 
  drop_na() %>% 
  ggplot(aes(x = segui, y = apbi, color = gse_zona)) +
  geom_point(size = 0.8) +
  geom_smooth(method = "lm", se = F, size = 0.8) +
  geom_smooth(aes(x = segui, y = apbi), 
              method = "lm", se = F, inherit.aes = F, colour = "black", size = 1, linetype = "twodash") +
  labs(x = "Seguridad", 
       y = "Pertenencia",
       color = "GSE Zona") +
  theme(legend.position = "top",
        legend.title = element_text(size = 10),
        legend.text = element_text(size = 10),
        axis.title = element_text(size = 10, face = "bold")) +
  scale_color_viridis(discrete = TRUE, option = "D") +
  facet_wrap(.~theil_segr_f)

##segregación~seguridad~soci
scat_soci_segr_segui <- elsoc_mean_zonas %>% 
  drop_na() %>% 
  ggplot(aes(x = segui, y = soci, color = gse_zona)) +
  geom_point(size = 0.8) +
  geom_smooth(method = "lm", se = F, size = 0.8) +
  geom_smooth(aes(x = segui, y = soci), 
              method = "lm", se = F, inherit.aes = F, colour = "black", size = 1, linetype = "twodash") +
  labs(x = "Seguridad", 
       y = "Sociabilidad",
       color = "GSE Zona") +
  theme(legend.position = "top",
        legend.title = element_text(size = 8),
        legend.text = element_text(size = 8),
        axis.title = element_text(size = 10, face = "bold")) +
  scale_color_viridis(discrete = TRUE, option = "D") +
  facet_wrap(.~theil_segr_f)


#scatter_segr_ms_cob <- ggarrange(scat_apbi_segr, scat_soci_segr, scat_apbi_segr_repbi, scat_soci_segr_repbi, ncol = 2, nrow = 3, common.legend = TRUE, legend = "top")
#ggsave(scatter_segr_ms_cob,filename = "../3_output/graficos/1_scatter_segr_ms_cob.png", width = 10, height = 8)

```


## H2: vitalidad->cohesión & vitalidad->ms~cohesion
```{r scat-jane}
scat_apbi_jane <- elsoc_mean_zonas %>% 
  ggplot(aes(x = jane_indx, y = apbi, color = gse_zona)) +
  geom_point(size = 0.8) +
  #geom_smooth(method = "lm", se = F, size = 0.8) +
  geom_smooth(se = F, size = 0.8) +
  geom_smooth(aes(x = jane_indx, y = apbi), 
              method="lm", se = F, inherit.aes = F, colour = "black", size = 1, linetype = "twodash") +
  labs(x = "Vitalidad", 
       y = "Pertenencia",
       color = "GSE Zona") +
  theme(legend.position = "top",
        legend.title = element_text(size = 10),
        legend.text = element_text(size = 10),
        axis.title = element_text(size = 10, face = "bold")) +
  scale_color_viridis(discrete = TRUE, option = "D")

scat_soci_jane <- elsoc_mean_zonas %>% 
  ggplot(aes(x = jane_indx, y = soci, color = gse_zona)) +
  geom_point(size = 0.8) +
  #geom_smooth(method = "lm", se = F, size = 0.8) +
  geom_smooth(se = F, size = 0.8) +
  geom_smooth(aes(x = jane_indx, y = soci), 
              method="lm", se = F, inherit.aes = F, colour = "black", size = 1, linetype = "twodash") +
  labs(x = "Vitalidad", 
       y = "Sociabilidad",
       color = "GSE Zona") +
  theme(legend.position = "top",
        legend.title = element_text(size = 10),
        legend.text = element_text(size = 10),
        axis.title = element_text(size = 10, face = "bold")) +
  scale_color_viridis(discrete = TRUE, option = "D")

scatter_dse_cob <- ggarrange(scat_apbi_segr, scat_soci_segr, scat_apbi_jane, scat_soci_jane,  ncol = 2, nrow = 2, common.legend = TRUE, legend = "top")
ggsave(scatter_dse_cob,filename = "../3_output/graficos/4_scatter_dse_cob.png", width = 8, height = 6, dpi = 300)
scatter_dse_cob
```

### H2.1 & H2.2
```{r scat-vita-ms}
#vitalidad~satisfacción

##vitalidad~satisfacción~apbi
scat_apbi_jane_sacci <- elsoc_mean_zonas %>% 
  drop_na() %>% 
  ggplot(aes(x = sacci, y = apbi, color = gse_zona)) +
  geom_point(size = 0.8) +
  geom_smooth(method = "lm", se = F, size = 0.8) +
  geom_smooth(aes(x = sacci, y = apbi), 
              method = "lm", se = F, inherit.aes = F, colour = "black", size = 1, linetype = "twodash") +
  labs(x = "Satisfacción", 
       y = "Pertenencia",
       color = "GSE Zona") +
  theme(legend.position = "top",
        legend.title = element_text(size = 8),
        legend.text = element_text(size = 8),
        axis.title = element_text(size = 10, face = "bold")) +
  scale_color_viridis(discrete = TRUE, option = "D") +
  facet_wrap(.~jane_indx_f)

##vitalidad~satisfacción~soci
scat_soci_jane_sacci <- elsoc_mean_zonas %>% 
  drop_na() %>% 
  ggplot(aes(x = sacci, y = soci, color = gse_zona)) +
  geom_point(size = 0.8) +
  geom_smooth(method = "lm", se = F, size = 0.8) +
  geom_smooth(aes(x = sacci, y = soci), 
              method = "lm", se = F, inherit.aes = F, colour = "black", size = 1, linetype = "twodash") +
  labs(x = "Satisfacción", 
       y = "Sociabilidad",
       color = "GSE Zona") +
  theme(legend.position = "top",
        legend.title = element_text(size = 8),
        legend.text = element_text(size = 8),
        axis.title = element_text(size = 10, face = "bold")) +
  scale_color_viridis(discrete = TRUE, option = "D") +
  facet_wrap(.~jane_indx_f)

#vitalidad~seguridad

##vitalidad~seguridad~apbi
scat_apbi_jane_segui <- elsoc_mean_zonas %>% 
  drop_na() %>% 
  ggplot(aes(x = segui, y = apbi, color = gse_zona)) +
  geom_point(size = 0.8) +
  geom_smooth(method = "lm", se = F, size = 0.8) +
  geom_smooth(aes(x = segui, y = apbi), 
              method = "lm", se = F, inherit.aes = F, colour = "black", size = 1, linetype = "twodash") +
  labs(x = "Seguridad", 
       y = "Pertenencia",
       color = "GSE Zona") +
  theme(legend.position = "top",
        legend.title = element_text(size = 8),
        legend.text = element_text(size = 8),
        axis.title = element_text(size = 10, face = "bold")) +
  scale_color_viridis(discrete = TRUE, option = "D") +
  facet_wrap(.~jane_indx_f)

##vitalidad~seguridad~soci
scat_soci_jane_segui <- elsoc_mean_zonas %>% 
  drop_na() %>% 
  ggplot(aes(x = segui, y = soci, color = gse_zona)) +
  geom_point(size = 0.8) +
  geom_smooth(method = "lm", se = F, size = 0.8) +
  geom_smooth(aes(x = segui, y = soci), 
              method = "lm", se = F, inherit.aes = F, colour = "black", size = 1, linetype = "twodash") +
  labs(x = "Seguridad", 
       y = "Sociabilidad",
       color = "GSE Zona") +
  theme(legend.position = "top",
        legend.title = element_text(size = 8),
        legend.text = element_text(size = 8),
        axis.title = element_text(size = 10, face = "bold")) +
  scale_color_viridis(discrete = TRUE, option = "D") +
  facet_wrap(.~jane_indx_f)

#scatter_jane_ms_cob <- ggarrange(scat_apbi_jane, scat_soci_jane, scat_apbi_jane_segui, scat_soci_jane_segui, ncol = 2, nrow = 3, common.legend = TRUE, legend="top")
#ggsave(scatter_jane_ms_cob,filename = "../3_output/graficos/2_scatter_jane_ms_cob.png", width = 10, height = 8)
```


## H3: ms->cohesion

```{r}
#reputación
scat_apbi_repbi <- elsoc_mean_zonas %>% 
  drop_na() %>% 
  ggplot(aes(x = repbi, y = apbi, color = gse_zona)) +
  geom_point(size = 0.8) +
  geom_smooth(method = "lm", se = F, size = 0.8) +
  geom_smooth(aes(x = repbi, y = apbi), 
              method = "lm", se = F, inherit.aes = F, colour = "black", size = 1, linetype = "twodash") +
  labs(x = "Reputación", 
       y = "Pertenencia",
       color = "GSE Zona") +
  theme(legend.position = "top",
        legend.title = element_text(size = 10),
        legend.text = element_text(size = 10),
        axis.title = element_text(size = 10, face = "bold")) +
  scale_color_viridis(discrete = TRUE, option = "D")

scat_soci_repbi <- elsoc_mean_zonas %>% 
  drop_na() %>% 
  ggplot(aes(x = repbi, y = soci, color = gse_zona)) +
  geom_point(size = 0.8) +
  geom_smooth(method = "lm", se = F, size = 0.8) +
  geom_smooth(aes(x = repbi, y = soci), 
              method = "lm", se = F, inherit.aes = F, colour = "black", size = 1, linetype = "twodash") +
  labs(x = "Reputación", 
       y = "Sociabilidad",
       color = "GSE Zona") +
  theme(legend.position = "top",
        legend.title = element_text(size = 10),
        legend.text = element_text(size = 10),
        axis.title = element_text(size = 10, face = "bold")) +
  scale_color_viridis(discrete = TRUE, option = "D")

#satisfacción
scat_apbi_sacci <- elsoc_mean_zonas %>% 
  drop_na() %>% 
  ggplot(aes(x = sacci, y = apbi, color = gse_zona)) +
  geom_point(size = 0.8) +
  geom_smooth(method = "lm", se = F, size = 0.8) +
  geom_smooth(aes(x = sacci, y = apbi), 
              method = "lm", se = F, inherit.aes = F, colour = "black", size = 1, linetype = "twodash") +
  labs(x = "Satisfacción", 
       y = "Pertenencia",
       color = "GSE Zona") +
  theme(legend.position = "top",
        legend.title = element_text(size = 10),
        legend.text = element_text(size = 10),
        axis.title = element_text(size = 10, face = "bold")) +
  scale_color_viridis(discrete = TRUE, option = "D") 

scat_soci_sacci <- elsoc_mean_zonas %>% 
  drop_na() %>% 
  ggplot(aes(x = sacci, y = soci, color = gse_zona)) +
  geom_point(size = 0.8) +
  geom_smooth(method = "lm", se = F, size = 0.8) +
  geom_smooth(aes(x = sacci, y = soci), 
              method = "lm", se = F, inherit.aes = F, colour = "black", size = 1, linetype = "twodash") +
  labs(x = "Satisfacción", 
       y = "Sociabilidad",
       color = "GSE Zona") +
  theme(legend.position = "top",
        legend.title = element_text(size = 10),
        legend.text = element_text(size = 10),
        axis.title = element_text(size = 10, face = "bold")) +
  scale_color_viridis(discrete = TRUE, option = "D") 

## seguridad
scat_apbi_segui <- elsoc_mean_zonas %>% 
  drop_na() %>% 
  ggplot(aes(x = segui, y = apbi, color = gse_zona)) +
  geom_point(size = 0.8) +
  geom_smooth(method = "lm", se = F, size = 0.8) +
  geom_smooth(aes(x = segui, y = apbi), 
              method = "lm", se = F, inherit.aes = F, colour = "black", size = 1, linetype = "twodash") +
  labs(x = "Seguridad", 
       y = "Pertenencia",
       color = "GSE Zona") +
  theme(legend.position = "top",
        legend.title = element_text(size = 10),
        legend.text = element_text(size = 10),
        axis.title = element_text(size = 10, face = "bold")) +
  scale_color_viridis(discrete = TRUE, option = "D")

##segregación~seguridad~soci
scat_soci_segui <- elsoc_mean_zonas %>% 
  drop_na() %>% 
  ggplot(aes(x = segui, y = soci, color = gse_zona)) +
  geom_point(size = 0.8) +
  geom_smooth(method = "lm", se = F, size = 0.8) +
  geom_smooth(aes(x = segui, y = soci), 
              method = "lm", se = F, inherit.aes = F, colour = "black", size = 1, linetype = "twodash") +
  labs(x = "Seguridad", 
       y = "Sociabilidad",
       color = "GSE Zona") +
  theme(legend.position = "top",
        legend.title = element_text(size = 10),
        legend.text = element_text(size = 10),
        axis.title = element_text(size = 10, face = "bold")) +
  scale_color_viridis(discrete = TRUE, option = "D")

scatter_ms_cob <- ggarrange(scat_apbi_repbi, scat_soci_repbi, scat_apbi_segui, scat_soci_segui, scat_apbi_sacci, scat_soci_sacci, ncol = 2, nrow = 3, common.legend = TRUE, legend="top")

ggsave(scatter_ms_cob,filename = "../3_output/graficos/5_scatter_ms_cob.png", width = 8, height = 8, dpi = 300)
```


# Análisis espacial

```{r mapa-gral, warning=FALSE}
elsoc_ams_all_geo %>%  
  group_by(cod_zona) %>% 
  summarise(n_encuestas = n(),
            prom_apbi = mean(apbi, na.rm = TRUE)) %>%  
  ungroup()

map_apbi <- mapview(elsoc_ams_all_geo, zcol = "apbr", layer.name = "Nivel de pertenencia", col.regions = mapviewPalette("mapviewRasterColors"), map.types = "CartoDB.VoyagerNoLabels")

mapshot(map_apbi, file = "../3_output/graficos/map_apbi.png", width = 10, height = 15)

mapview(elsoc_ams_all_geo, zcol = "theil_segr", ap.types = "CartoDB.VoyagerNoLabels")

```

```{r plot-map-theil}
plot_theil <- ggplot(data = elsoc_ams_all) + 
  geom_sf(aes(fill = theil_segr, geometry = geometry)) +
  coord_sf(datum = st_crs(31979)) + 
  scale_fill_viridis_c(direction = -1) +
  theme_void() +
  theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank()) +
  labs(fill = "Segregación\n(índice de Theil)")
plot_theil
ggsave(filename = "../3_output/graficos/map-theil.jpg", width = 15, height = 15, units = "cm")
```

```{r plot-map-jane}
plot_jane <- ggplot(data = elsoc_ams_all) + 
  geom_sf(aes(fill = ave_jane, geometry = geometry)) +
  coord_sf(datum = st_crs(31979)) + 
  scale_fill_viridis_c(direction = -1) +
  theme_void() +
  theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank()) +
  labs(fill = "Vitalidad\n(indice de Jane)")
plot_jane
ggsave(filename = "../3_output/graficos/map-jane.jpg", width = 15, height = 15, units = "cm")
```

```{r plot-map-apbi}
plot_apbi <- ggplot(data = elsoc_ams_all) + 
  geom_sf(aes(fill = apbi, geometry = geometry)) +
  coord_sf(datum = st_crs(31979)) +
  scale_fill_viridis_c(direction = -1, option = "plasma") +
  theme_void() +
  theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank()) +
  labs(fill = "Indice de\npertenencia barrial")
plot_apbi
ggsave(filename = "../3_output/graficos/map-apbi.jpg", width = 15, height = 15, units = "cm")
```

```{r plot-map-soci}
plot_soci <- ggplot(data = elsoc_ams_all) + 
  geom_sf(aes(fill = soci, geometry = geometry)) +
  coord_sf(datum = st_crs(31979)) +
  scale_fill_viridis_c(direction = -1, option = "plasma") +
  theme_void() +
  theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank()) +
  labs(fill = "Indice de\nsociabilidad barrial")
plot_soci
ggsave(filename = "../3_output/graficos/map-soci.jpg", width = 15, height = 15, units = "cm")
```

