---
title: "Código de Análisis de Datos"
author: "Cristóbal Ortiz"
date: "08-10-2021"
output: html_document
---

```{r load-library, message=FALSE, warning=FALSE}
library(tidyverse)
library(sjPlot)
library(gstat)
library(raster)
library(rgdal)
library(rworldxtra)
library(sf)
library(sp)
library(chilemapas)
library(mapview)
library(viridis)
library(elsoc)
library(sjlabelled)
```

```{r load-dataset}
remove(list = ls())
load("../1_input/data/procesada/elsoc_ams.RData")
load("../1_input/data/procesada/elsoc_ams_all.RData")

load("../1_input/data/procesada/elsoc_ams_geo.RData")
load("../1_input/data/procesada/elsoc_ams_all_geo.RData")

load(url("https://dataverse.harvard.edu/api/access/datafile/7245118"))
elsoc_long <- elsoc_long_2016_2022.2
```

```{r summarise-dataset, message=TRUE, warning=FALSE}
elsoc_mean_zonas <- elsoc_ams %>% 
  group_by(cod_zona) %>% 
  dplyr::select(idencuesta, cod_zona, 
                apbi, soci, 
                segui, repbi, sacci, 
                edadi, educi, essui, time,  
                theil_pola, ismt_rank, theil_mixt, theil_segr, jane_indx) %>% 
  summarise_all(mean, na.rm = T)

elsoc_mean_zonas <- elsoc_mean_zonas %>% 
  mutate(gse_zona = factor(with(elsoc_mean_zonas, case_when(ismt_rank > 0.7325960 ~ 1,
                                                      ismt_rank > 0.5201545 ~ 2,
                                                      ismt_rank <= 0.5201545 ~ 3)),
                           labels = c('Alto', 'Medio', 'Bajo'),
                           levels = c(1,2,3)))

```
# Descriptivo general

```{r desc-table}
elsoc_ams2 <- elsoc_ams %>% 
  dplyr::select(-geometry)

summarytools::dfSummary(elsoc_ams2, style = "grid")
```


# Análisis univariado

```{r cob-estrato}
bar_apbi <- elsoc_long %>% 
  filter(tipo_atricion == 1 & ola %in% 1:6, !is_nsnr(t02_01, t02_02, t02_03, t02_04)) %>% 
  mutate(spb = (t02_01 + t02_02 + t02_03 + t02_04)/4,
         spb_rec = factor(cut(spb, breaks = c(0,2.75,3.75,5)),
                                  labels = c("Niveles bajos","Niveles intermedios","Niveles altos")),
         estrato = factor(estrato, levels = c(1,2,3,4,5,6),
                          labels = c('Gran\nSantiago', 'Gran\nValparaíso', 'Gran\nConcepción',
                                     'Ciudades\ngrandes', 'Ciudades\nmedianas', 'Ciudades\npequeñas'))) %>% 
  prop(x = spb_rec, by = c(ola, estrato), na.rm = TRUE) %>% 
  as_label(ola) %>% 
  filter(spb_rec == "Niveles altos") %>% 
  ggplot(aes(y = prop, x = estrato, fill = ola, 
             label = as.character(scales::percent(prop, accuracy = .1)))) + 
  theme_bw() + 
  geom_col(position = 'dodge2') +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 1)) +
  scale_fill_viridis_d(begin = .22, end = .88, direction = -1) +
  theme(plot.caption = element_text(hjust = 0),
        legend.position = 'top',
        legend.title = element_blank()) +
  geom_text(vjust = -0.8,
            position = position_dodge(width = .9),
            size = 2) +
  labs(x = NULL, y = NULL,
       title = 'Nivel de pertenencia al barrio según ola y tipo de ciudad',
       subtitle = 'Porcentaje con niveles altos (>3.75)')

bar_soci <- elsoc_long %>% 
  filter(tipo_atricion == 1 & ola %in% 1:6, !is_nsnr(t02_01, t02_02, t02_03, t02_04)) %>% 
  mutate(soci = (t03_01 + t03_02 + t03_03 + t03_04)/4,
         soci_rec = factor(cut(soci, breaks = c(0,2.75,3.75,5)),
                                  labels = c("Niveles bajos","Niveles intermedios","Niveles altos")),
         estrato = factor(estrato, levels = c(1,2,3,4,5,6),
                          labels = c('Gran\nSantiago', 'Gran\nValparaíso', 'Gran\nConcepción',
                                     'Ciudades\ngrandes', 'Ciudades\nmedianas', 'Ciudades\npequeñas'))) %>% 
  prop(x = soci_rec, by = c(ola, estrato), na.rm = TRUE) %>% 
  as_label(ola) %>% 
  filter(soci_rec == "Niveles altos") %>% 
  ggplot(aes(y = prop, x = estrato, fill = ola, 
             label = as.character(scales::percent(prop, accuracy = .1)))) + 
  theme_bw() + 
  geom_col(position = 'dodge2') +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 1)) +
  scale_fill_viridis_d(begin = .22, end = .88, direction = -1) +
  theme(plot.caption = element_text(hjust = 0),
        legend.position = 'top',
        legend.title = element_blank()) +
  geom_text(vjust = -0.8,
            position = position_dodge(width = .9),
            size = 2) +
  labs(x = NULL, y = NULL,
       title = 'Nivel de sociabilidad barrial según ola y tipo de ciudad',
       subtitle = 'Porcentaje con niveles altos (>3.75)')

bar_cob <- gridExtra::grid.arrange(bar_apbi, bar_soci,  nrow = 2)
ggsave(bar_cob,filename = "../3_output/graficos/bar_cob.png", width = 8, height = 10)

```

# Análisis bivariado

```{r correlation}
psych::pairs.panels(elsoc_mean_zonas,
             smooth = TRUE,      # If TRUE, draws loess smooths
             scale = FALSE,      # If TRUE, scales the correlation text font
             density = TRUE,     # If TRUE, adds density plots and histograms
             ellipses = F,       # If TRUE, draws ellipses
             method = "pearson", # Correlation method (also "spearman" or "kendall")
             pch = 21,           # pch symbol
             lm = TRUE,          # If TRUE, plots linear fit rather than the LOESS (smoothed) fit
             cor = TRUE,         # If TRUE, reports correlations
             jiggle = FALSE,     # If TRUE, data points are jittered
             factor = 2,         # Jittering factor
             hist.col = 4,       # Histograms color
             stars = TRUE,       # If TRUE, adds significance level with stars
             ci = TRUE)          # If TRUE, adds confidence intervals
```

## Bivariado a nivel barrial (promedios por zona)

```{r scatt-zona, message=FALSE, warning=FALSE}
scat_apbi_segr <- elsoc_mean_zonas %>% 
  ggplot(aes(x = theil_segr, y = apbi, color = gse_zona)) +
  geom_point(size = 0.8) +
  geom_smooth(method = "lm", se = F, size = 0.8) +
  geom_smooth(aes(x = theil_segr, y = apbi), 
              method = "lm", se = F, inherit.aes = F, colour = "black", size = 1, linetype = "twodash") +
  labs(x = "Nivel de segregación residencial", 
       y = "Promedio de pertenencia barrial",
       color = "GSE Zona") +
  theme(legend.position = c(0.9, 0.2),
        legend.title = element_text(size = 8),
        legend.text = element_text(size = 8),
        axis.title = element_text(size = 10, face = "bold")) +
  scale_color_viridis(discrete = TRUE, option = "D")

scat_soci_segr <- elsoc_mean_zonas %>% 
  ggplot(aes(x = theil_segr, y = soci, color = gse_zona)) +
  geom_point(size = 0.8) +
  geom_smooth(method = "lm", se = F, size = 0.8) +
  geom_smooth(aes(x = theil_segr, y = soci), 
              method="lm", se = F, inherit.aes = F, colour = "black", size = 1, linetype = "twodash") +
  labs(x = "Nivel de segregación residencial", 
       y = "Promedio de sociabilidad barrial",
       color = "GSE Zona") +
  theme(legend.position = c(0.9, 0.2),
        legend.title = element_text(size = 8),
        legend.text = element_text(size = 8),
        axis.title = element_text(size = 10, face = "bold")) +
  scale_color_viridis(discrete = TRUE, option = "D")

scat_apbi_jane <- elsoc_mean_zonas %>% 
  ggplot(aes(x = jane_indx, y = apbi, color = gse_zona)) +
  geom_point(size = 0.8) +
  geom_smooth(method = "lm", se = F, size = 0.8) +
  geom_smooth(aes(x = jane_indx, y = apbi), 
              method="lm", se = F, inherit.aes = F, colour = "black", size = 1, linetype = "twodash") +
  labs(x = "Nivel de vitalidad del entorno", 
       y = "Promedio de pertenencia barrial",
       color = "GSE Zona") +
  theme(legend.position = c(0.9, 0.2),
        legend.title = element_text(size = 8),
        legend.text = element_text(size = 8),
        axis.title = element_text(size = 10, face = "bold")) +
  scale_color_viridis(discrete = TRUE, option = "D")

scat_soci_jane <- elsoc_mean_zonas %>% 
  ggplot(aes(x = jane_indx, y = soci, color = gse_zona)) +
  geom_point(size = 0.8) +
  geom_smooth(method = "lm", se = F, size = 0.8) +
  geom_smooth(aes(x = jane_indx, y = soci), 
              method="lm", se = F, inherit.aes = F, colour = "black", size = 1, linetype = "twodash") +
  labs(x = "Nivel de vitalidad del entorno", 
       y = "Promedio de sociabilidad barrial",
       color = "GSE Zona") +
  theme(legend.position = c(0.9, 0.2),
        legend.title = element_text(size = 8),
        legend.text = element_text(size = 8),
        axis.title = element_text(size = 10, face = "bold")) +
  scale_color_viridis(discrete = TRUE, option = "D")

scatter_dse_cob <- gridExtra::grid.arrange(scat_apbi_segr, scat_soci_segr ,scat_apbi_jane, scat_soci_jane,  ncol = 2, nrow = 2)

ggsave(scatter_dse_cob,filename = "../3_output/graficos/scatter_dse_cob.png", width = 10, height = 6)

scatter_dse_cob
```

# Análisis espacial

```{r mapa-gral, warning=FALSE}
elsoc_ams_all_geo %>%  
  group_by(cod_zona) %>% 
  summarise(n_encuestas = n(),
            prom_apbi = mean(apbi, na.rm = TRUE)) %>%  
  ungroup()

map_apbi <- mapview(elsoc_ams_all_geo, zcol = "apbr", layer.name = "Nivel de pertenencia", col.regions = mapviewPalette("mapviewRasterColors"), map.types = "CartoDB.VoyagerNoLabels")

mapshot(map_apbi, file = "../3_output/graficos/map_apbi.png", width = 10, height = 15)

mapview(elsoc_ams_all_geo, zcol = "hi_theil", ap.types = "CartoDB.VoyagerNoLabels")

```

```{r plot-map-theil}
plot_theil <- ggplot(data = elsoc_ams_all) + 
  geom_sf(aes(fill = theil_segr, geometry = geometry)) +
  coord_sf(datum = st_crs(31979)) + 
  scale_fill_viridis_c(direction = -1) +
  theme_void() +
  theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank()) +
  labs(fill = "Segregación\n(índice de Theil)")
plot_theil
ggsave(filename = "../3_output/graficos/map-theil.jpg", width = 15, height = 15, units = "cm")
```

```{r plot-map-jane}
plot_jane <- ggplot(data = elsoc_ams_all) + 
  geom_sf(aes(fill = ave_jane, geometry = geometry)) +
  coord_sf(datum = st_crs(31979)) + 
  scale_fill_viridis_c(direction = -1) +
  theme_void() +
  theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank()) +
  labs(fill = "Vitalidad\n(indice de Jane)")
plot_jane
ggsave(filename = "../3_output/graficos/map-jane.jpg", width = 15, height = 15, units = "cm")
```

```{r plot-map-apbi}
plot_apbi <- ggplot(data = elsoc_ams_all) + 
  geom_sf(aes(fill = apbi, geometry = geometry)) +
  coord_sf(datum = st_crs(31979)) +
  scale_fill_viridis_c(direction = -1, option = "plasma") +
  theme_void() +
  theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank()) +
  labs(fill = "Indice de\npertenencia barrial")
plot_apbi
ggsave(filename = "../3_output/graficos/map-apbi.jpg", width = 15, height = 15, units = "cm")
```

```{r plot-map-soci}
plot_soci <- ggplot(data = elsoc_ams_all) + 
  geom_sf(aes(fill = soci, geometry = geometry)) +
  coord_sf(datum = st_crs(31979)) +
  scale_fill_viridis_c(direction = -1, option = "plasma") +
  theme_void() +
  theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank()) +
  labs(fill = "Indice de\nsociabilidad barrial")
plot_soci
ggsave(filename = "../3_output/graficos/map-soci.jpg", width = 15, height = 15, units = "cm")
```

